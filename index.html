<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssChat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        #chat-container, #join-container {
            width: 80%;
            max-width: 600px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 20px;
        }
        #chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 20px;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }
        #chat-form, #join-form {
            display: flex;
            flex-direction: column;
        }
        input, button {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        #create-room-btn {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="join-container">
        <h2>AssChat</h2>
        <form id="join-form">
            <input type="text" id="username-input" placeholder="Enter your username" required>
            <button type="button" id="create-room-btn">Create New Room</button>
        </form>
    </div>

    <div id="chat-container" style="display: none;">
        <h2>AssChat Room</h2>
        <div id="chat-messages"></div>
        <form id="chat-form">
            <input type="text" id="message-input" placeholder="Type your message..." required>
            <button type="submit">Send</button>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        let socket;
        let roomId;
        let userName;
        let encryptionKey;

        const joinContainer = document.getElementById('join-container');
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const createRoomBtn = document.getElementById('create-room-btn');
        const usernameInput = document.getElementById('username-input');

        chatForm.addEventListener('submit', sendMessage);
        createRoomBtn.addEventListener('click', createRoom);

        function encode(message) {
            const iv = CryptoJS.lib.WordArray.random(16); // 16 byte iv
            const encrypted = CryptoJS.AES.encrypt(message, CryptoJS.enc.Hex.parse(encryptionKey), { iv: iv });
            const ivCiphertext = iv.concat(encrypted.ciphertext); // WHY DOES THIS NOT WORK
            return CryptoJS.enc.Base64.stringify(ivCiphertext); // base64
        }
        
        function decode(encodedMessage) {
            const ivCiphertext = CryptoJS.enc.Base64.parse(encodedMessage); // simple enough
            const iv = CryptoJS.lib.WordArray.create(ivCiphertext.words.slice(0, 4)); // extract 1\fist 16 bytes (iv)
            const ciphertext = CryptoJS.lib.WordArray.create(ivCiphertext.words.slice(4)); // extraxt ciphertext
        
            const decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, CryptoJS.enc.Hex.parse(encryptionKey), { iv: iv });
            return decrypted.toString(CryptoJS.enc.Utf8); // convert to readable (UTF-8)
        }

        function createRoom() {
            userName = usernameInput.value.trim();
            if (!userName) {
                return alert('where the nigga username!?');
            }
            localStorage.setItem('username', userName);
            socket = new WebSocket(`ws://${window.location.host}`); // ez fix!! :3
            socket.onopen = () => {
                socket.send(JSON.stringify({ type: 'create' }));
            };
            setupSocket();
        }

        function setupSocket() {
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                // first time ive ever used case
                switch (data.type) {
                    case 'roomCreated':
                        roomId = data.roomId;
                        encryptionKey = CryptoJS.SHA256(roomId).toString();
                        window.location.href = `/?room=${roomId}`;
                        break;
                    case 'joined':
                        showChatRoom(data.userName, data.messages);
                        break;
                    case 'message':
                        //                              very secure
                        displayMessage(data.userName, decode(data.content));
                        break;
                    case 'error':
                        alert(data.message);
                        break;
                }
            };

            socket.onclose = () => {
                alert('connection the server closed');
                window.location.href = '/';
            };
        }

        function sendMessage(event) {
            event.preventDefault();
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            if (message && socket.readyState === WebSocket.OPEN) {
                const encodedMessage = encode(message);
                socket.send(JSON.stringify({ type: 'message', content: encodedMessage }));
                messageInput.value = '';
            }
        }

        function displayMessage(user, content) {
            const messageElement = document.createElement('p');
            messageElement.textContent = `${user}: ${content}`;
            document.getElementById('chat-messages').appendChild(messageElement);
        }

        function showChatRoom(user, messages) {
            joinContainer.style.display = 'none';
            chatContainer.style.display = 'block';
            userName = user;
            messages.forEach(msg => displayMessage(msg.userName, decode(msg.content)));
        }

        const saveduser = localStorage.getItem('username');
        if (saveduser) {
            usernameInput.value = saveduser;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const roomParam = urlParams.get('room');
        if (roomParam) {
            roomId = roomParam;
            encryptionKey = CryptoJS.SHA256(roomId).toString();
            userName = usernameInput.value.trim() || saveduser;
            if (userName) {
                socket = new WebSocket(`ws://${window.location.host}`);
                socket.onopen = () => {
                    socket.send(JSON.stringify({ type: 'join', userName, roomId }));
                };
                setupSocket();
            } else {
                joinContainer.style.display = 'block';
            }
        }
    </script>
</body>
</html>